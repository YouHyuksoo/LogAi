# ==============================================================================
# docker-compose.dev.yml
# ==============================================================================
# LogAi 개발 환경 Docker Compose 설정
#
# 주요 특징:
# 1. Hot-reload 활성화 (코드 변경 시 즉시 반영)
# 2. Backend: uvicorn --reload 모드
# 3. Frontend: npm run dev (Next.js 개발 서버)
# 4. 볼륨 마운트로 로컬 코드와 동기화
#
# 실행 방법:
#   docker-compose -f docker-compose.dev.yml up -d
#
# GPU 포함 개발:
#   docker-compose -f docker-compose.dev.yml -f docker-compose.ai.yml up -d
#
# 주의사항:
#   - 프로덕션 환경에서는 절대 사용 금지!
#   - 개발 중 빠른 피드백을 위한 설정입니다.
# ==============================================================================

version: '3.8'

services:
  # 1. Message Broker (Kafka Compatible)
  redpanda:
    image: docker.redpanda.com/redpandadata/redpanda:v23.3.4
    container_name: redpanda
    command:
      - redpanda start
      - --smp 1
      - --memory 1G
      - --reserve-memory 0M
      - --overprovisioned
      - --node-id 0
      - --check=false
      - --kafka-addr PLAIN://0.0.0.0:9092,OUTSIDE://0.0.0.0:29092
      - --advertise-kafka-addr PLAIN://redpanda:9092,OUTSIDE://localhost:29092
      - --pandaproxy-addr 0.0.0.0:8082
      - --advertise-pandaproxy-addr localhost:8082
    ports:
      - 8081:8081   # Schema Registry
      - 8082:8082   # REST Proxy
      - 29092:29092 # Kafka API (External)
      - 9644:9644   # Admin API
    volumes:
      - ./data/redpanda:/var/lib/redpanda/data
    networks:
      - logai-net
    healthcheck:
      test: ["CMD-SHELL", "rpk cluster health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # 2. OLAP Database (Logs & Stats)
  clickhouse:
    image: clickhouse/clickhouse-server:24.1
    container_name: clickhouse
    ports:
      - 8123:8123 # HTTP
      - 9000:9000 # Native
    volumes:
      - ./data/clickhouse:/var/lib/clickhouse
      - ./config/clickhouse_users.xml:/etc/clickhouse-server/users.d/users.xml:ro
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    networks:
      - logai-net
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8123/ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # 3. Vector Database (RAG)
  qdrant:
    image: qdrant/qdrant:v1.7.4
    container_name: qdrant
    ports:
      - 6333:6333 # REST API
      - 6334:6334 # gRPC
    volumes:
      - ./data/qdrant:/qdrant/storage
    networks:
      - logai-net
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    healthcheck:
      test: ["CMD-SHELL", "bash -c '</dev/tcp/localhost/6333'"]
      interval: 10s
      timeout: 5s
      retries: 5

  # 4. Log Collector (Rust Agent)
  vector:
    image: timberio/vector:0.36.0-debian
    container_name: vector
    volumes:
      - ./config/vector.toml:/etc/vector/vector.toml:ro
      - ./data/vector:/var/lib/vector
    depends_on:
      redpanda:
        condition: service_healthy
      clickhouse:
        condition: service_healthy
    networks:
      - logai-net

  # 5. Backend API (FastAPI) - 개발 모드 (Hot-reload)
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: logai-backend
    command: uvicorn main:app --reload --host 0.0.0.0 --port 8000  # --reload 추가!
    ports:
      - 8000:8000
    environment:
      - REDPANDA_BROKER=redpanda:9092
      - CLICKHOUSE_HOST=clickhouse
      - CLICKHOUSE_PORT=8123
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - VLLM_URL=http://vllm:8000/v1
      - TEI_URL=http://tei:8080
    env_file:
      - .env
    volumes:
      - ./backend:/app  # 로컬 코드 마운트 (코드 변경 시 즉시 반영)
    depends_on:
      redpanda:
        condition: service_healthy
      clickhouse:
        condition: service_healthy
      qdrant:
        condition: service_healthy
    networks:
      - logai-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 6. Frontend (Next.js) - 개발 모드 (Hot-reload)
  frontend:
    image: node:22-alpine  # 개발용으로 베이스 이미지 직접 사용
    container_name: logai-frontend
    working_dir: /app
    command: sh -c "npm install && npm run dev"  # 의존성 설치 후 개발 서버 실행
    ports:
      - 3000:3000
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8000
      - NODE_ENV=development
    volumes:
      - ./frontend:/app  # 로컬 코드 마운트
      - /app/node_modules  # node_modules는 컨테이너 것 사용 (윈도우 호환성)
      - /app/.next  # .next 빌드 캐시도 컨테이너 것 사용
    depends_on:
      - backend
    networks:
      - logai-net

networks:
  logai-net:
    driver: bridge
