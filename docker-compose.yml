# ==============================================================================
# docker-compose.yml (개발용 인프라)
# ==============================================================================
# LogAi 개발 환경 - 인프라 서비스만 실행
#
# 포함 서비스:
# 1. Redpanda (메시지 브로커)
# 2. ClickHouse (로그 저장소)
# 3. Qdrant (벡터 DB)
#
# Backend/Frontend는 로컬에서 직접 실행:
#   cd backend && uvicorn main:app --reload --host 0.0.0.0 --port 8000
#   cd frontend && npm run dev
#
# 프로덕션 배포:
#   docker-compose -f docker-compose.prod.yml up -d
# ==============================================================================

version: '3.8'

services:
  # 1. Message Broker (Kafka Compatible)
  redpanda:
    image: docker.redpanda.com/redpandadata/redpanda:v23.3.4
    container_name: redpanda
    command:
      - redpanda start
      - --smp 1
      - --memory 1G
      - --reserve-memory 0M
      - --overprovisioned
      - --node-id 0
      - --check=false
      - --kafka-addr PLAIN://0.0.0.0:9092,OUTSIDE://0.0.0.0:29092
      - --advertise-kafka-addr PLAIN://redpanda:9092,OUTSIDE://localhost:29092
      - --pandaproxy-addr 0.0.0.0:8082
      - --advertise-pandaproxy-addr localhost:8082
    ports:
      - 8081:8081   # Schema Registry
      - 8082:8082   # REST Proxy
      - 29092:29092 # Kafka API (External)
      - 9644:9644   # Admin API
    volumes:
      - ./data/redpanda:/var/lib/redpanda/data
    networks:
      - logai-net
    healthcheck:
      test: ["CMD-SHELL", "rpk cluster health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # 2. OLAP Database (Logs & Stats)
  clickhouse:
    image: clickhouse/clickhouse-server:24.1
    container_name: clickhouse
    ports:
      - 8123:8123 # HTTP
      - 9000:9000 # Native
    volumes:
      # Docker named volume instead of host mount (avoids Windows permission issues)
      - clickhouse_data:/var/lib/clickhouse
      - ./config/clickhouse_users.xml:/etc/clickhouse-server/users.d/users.xml:ro
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    networks:
      - logai-net
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8123/ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # 3. Vector Database (RAG)
  qdrant:
    image: qdrant/qdrant:v1.7.4
    container_name: qdrant
    ports:
      - 6333:6333 # REST API
      - 6334:6334 # gRPC
    volumes:
      - ./data/qdrant:/qdrant/storage
    networks:
      - logai-net
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    healthcheck:
      test: ["CMD-SHELL", "bash -c '</dev/tcp/localhost/6333'"]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  logai-net:
    driver: bridge

volumes:
  clickhouse_data:
    driver: local
